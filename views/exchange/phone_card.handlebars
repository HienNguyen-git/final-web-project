<div class="container w-50 mt-5">
  <h1>Phone Card</h1>
  <form id="phone-card-form">
    <div class="form-group">
      <label for="networkProvider">Network provider</label>
      <select class="form-control" name="networkProvider" id="networkProvider">
        <option disabled selected>Please select your network</option>
        {{#each networkProvider}}
          <option value="{{provider_number}}">{{name}}</option>
        {{/each}}
      </select>
    </div>
    <div class="form-group">
      <p>Fee: <span id="fee"></span>%</p>
    </div>
    <div class="form-group">
      <div class="form-check form-check-inline">
        <input
          class="form-check-input"
          type="radio"
          name="type"
          id="10000"
          value="10000"
        />
        <label class="form-check-label" for="10000">10,000đ</label>
      </div>
      <div class="form-check form-check-inline">
        <input
          class="form-check-input"
          type="radio"
          name="type"
          id="20000"
          value="20000"
        />
        <label class="form-check-label" for="20000">20,000đ</label>
      </div>
      <div class="form-check form-check-inline">
        <input
          class="form-check-input"
          type="radio"
          name="type"
          id="50000"
          value="50000"
        />
        <label class="form-check-label" for="50000">50,000đ</label>
      </div>
      <div class="form-check form-check-inline">
        <input
          class="form-check-input"
          type="radio"
          name="type"
          id="100000"
          value="100000"
        />
        <label class="form-check-label" for="100000">100,000đ</label>
      </div>
    </div>

    <div class="form-group">
      <label for="networkProvider">Amount</label>
      <select class="form-control" name="amount">
        <option disabled selected>Please select amount</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
    </div>
    <div class="form-group" id="my-alert">
    </div>
    <button class="btn btn-primary col-sm-12" type="submit">Buy</button>
  </form>
</div>

<script>
  const formCardPhone = document.getElementById('phone-card-form')
  const networkProviderBox = document.getElementById('networkProvider')
  const myAlert = document.getElementById('my-alert')
  let myFee

  if(networkProviderBox){
    networkProviderBox.addEventListener('change',async e=>{
      const myFetch = await fetch(location.href+"/fee?code="+e.target.value)
      const res = await myFetch.json()
      myFee = res.data[0].fee
      document.querySelector('#fee').innerHTML = res.data[0].fee
    })
  }

  if (formCardPhone) {
      formCardPhone.addEventListener('submit', async e => {
          e.preventDefault()
          const formData = new FormData(e.target)
          const { networkProvider, type, amount } = Object.fromEntries(formData);
          if (networkProvider === undefined) {
              showAlert("Please select your network provider")
          } else if (type === undefined) {
              showAlert("Please choose our price type")
          } else if (amount === undefined) {
              showAlert("Please select amount")
          } else {
              myAlert.innerHTML = ""
              const myFetch = await fetch(location.href, {
                  method: "POST", 
                  body: JSON.stringify({
                      name: networkProvider, type, amount, fee: myFee
                  }), 
                  headers: {
                      'Content-Type': 'application/json'
                  },
              })
              const res = await myFetch.json() 
              console.log(res)
              if (!res.code) { 
                alert('Ticket purchase was successful. Here are your code: '+ res.data+"\nYou can view your code again in Dashbroad") 
                window.location.reload();
              } 
              else showAlert(res.message)
          }
      })
  } function showAlert(message) {
      myAlert.innerHTML = "" 
      const content = ` <div class="alert alert-danger" role="alert"> ${message}</div> ` 
      myAlert.insertAdjacentHTML('beforeend', content)
  }
</script>